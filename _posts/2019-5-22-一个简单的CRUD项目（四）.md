---
layout:     post   				    # 使用的布局（不需要改）
title:      一个简单的CRUD项目（四）			# 标题 
subtitle:   使用Vue和Springboot搭建  #副标题
date:       2019-5-22 				# 时间
author:     Tempo					# 作者
header-img: img/post-bg-os-metro.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - JAVA
    - JHipster
    - bug
    - JAVA学习
    - JDL
    - microservice
---
# microservice 微服务

#### 

# 通过JDL创建JHipster项目
[官方中文文档](https://www.jhipster-cn.tech/jdl/)

#### 使用JDL工具
* 可以定义应用属性和实体
* 定义实体对象和属性和关联
* 定义JHipster的选项

[所有选项](https://www.jhipster-cn.tech/jdl/#annexes),
通常定义如下<br/>
```js
application {
    config {
        baseName myapp //app名称
        applicationType microservice //可选monolith
        prodDatabaseType mysql //??
        buildTool maven //可选gradle
        packageName	com.mycompany.myapp	
        authenticationType jwt//连接类型 jwt, session, uaa, oauth2
        databaseType sql
        devDatabaseType mysql //h2Disk 
        cacheProvider ehcache //缓存类型
        nativeLanguage Chinese(Simplified) //en
        languages [Chinese(Simplified), en]
        serverPort 8180
    }
    entities *
}

entity UserOperation { //必须大写开头 采取驼峰规则
    userId String // 也可采用enum类型
}

entity Hello {
    world String
}
relationship OneToOne {
    UserOperation{userId} to Hello
}
dto * except Hello
service * with serviceClass
```

之后则可以
```jhipster import-jdl your-jdl-file.jdl```
如果是创建应用，则可在父文件夹下直接执行，可拼接多个JDL文件。<br/>
但是实际应用中遇到了问题：只有.jhipster/xx.json格式文件和一个.yo-sc.json文件生成。莫非是不能直接生成mono，只能直接生成microservice？

# 在JHipster中创建microservice项目

[参考创建流程blog](https://www.jdon.com/50161)

#### 单体应用架构和微服务应用架构的对比
* 单体应用架构：便于共享，易于测试和部署；复杂性高，扩展能力和创新能力受限，产生技术债务积累。
* 微服务架构：将一个应用程序开发为一组小型服务，每个服务运行在自己的进程中，服务间采用轻量级通信机制。单个服务启动较快，技术栈不受限制；运维要求高，分布式复杂，接口调整成本高（微服务采用接口进行通信）。
  
微服务开发技术点：
1. 服务注册、发现、负载均衡、容错（服务注册中心兼配置中心）
2. 服务之间的通信（消息模式，RPC模式）
3. api网关（路由，监控，安全认证，日志，限流）
4. 微服务周边设施（日志中心，监控中心，文档自动生成）

JHipster以以下方式工作微服务架构（目前并不清楚到底是怎么架构的）：
1. [gateway](https://www.jhipster-cn.tech/api-gateway/)（网关）由JHipster生成，处理网络流量，为一个Angular应用服务，可以存在多个网关。
2. [Traefik](https://www.jhipster-cn.tech/traefik/)，是一个现代化的 HTTP 反向代理及负载均衡器，它可以和网关集成工作。
3. [JHipster Registry](https://www.jhipster-cn.tech/jhipster-registry/) 是一个所有应用注册和配置中心。它还能提供运行时监控仪表盘。
Consul 是一个服务发现提供者，使用键/值对存储。它可以作为 JHipster Registry 的替代。
4. [JHipster UAA](https://www.jhipster-cn.tech/using-uaa/) 是一个 JHipster 构建的 User 认证和鉴权中心，使用 OAuth2 协议。
5. [Microservices](https://www.jhipster-cn.tech/creating-microservices/) 是指一堆用 JHipster 构建的应用（使用应用类型：microservice application），它们处理 REST 请求。它们都是无状态的，以及它们中的一些可以被运行为多个实例来应对高负载。
6. [JHipster Console](https://github.com/jhipster/jhipster-console) 是一个监控和告警控制台，使用 ELK 架构。


jhipster启动流程：
1. 启动jhipster-registry（服务和网关依赖注册中心，）
2. 启动jhipster-console（控制台，优先启动于具体服务）
3. 启动具体服务（每个微服务模块）
4. 启动网关（gateway项目类型，基于angular的前端）

#### 安装新的依赖
需要安装docker，docker-compose<br/>
[在centos7上配置docker](https://www.runoob.com/docker/centos-docker-install.html)
[在centos7上配置docker-compose](https://www.centos.bz/2019/01/centos7-%E5%AE%89%E8%A3%85-docker-%E5%92%8C-docker-compose/)
[centos7上配置docker的proxy](https://my.oschina.net/tinkercloud/blog/638960)

#### docker和docker-compose（待学习）
[docker&docker-compose](https://www.jhipster-cn.tech/docker-compose/)
绕不过docker这个东西了看来。docker好像是用于生成一个稳定的软件环境。
以前在实验室pull镜像没什么问题，出来以后pull镜像出现timeout问题，然后才知道以前有人说，docker网站不稳定是真的，
从如下两篇中找到了解决方法。
第一篇文章中，讲了如何各个系统中如何修改docker配置的。
链接如下：http://www.jianshu.com/p/9fce6e583669
第二篇文章说明了国内各个仓库镜像的对比。
同样附上链接：http://www.datastart.cn/tech/2016/09/28/docker-mirror.html


#### JHipster官网微服务架构


#### 创建流程
1. 创建JDL

#### 遇到的bug
1. 为什么jhpister-registry上不了了（转接了一个ip地址的问题？）
2. 为什么./mvnw不能用 只能用mvn
3. //为什么docker这么难>.<
4. Cannot clone or checkout repository（自己创建Registry没有输入那串神秘的代码会出现的错误）
5. docker根据导师步骤创建mysql，连接失败（是我自己密码输错了orz）。
   进行了：1.docker exec数据库 2.command连接数据库 3.micro连接数据库
   docker链接数据库正常通过，在command远程连接mysql的时候必须要指定数据库名称-D sqlName
6. Request execution error. endpoint=DefaultEndpoint{ serviceUrl='http://admin:admin@localhost:8761/eureka/}
com.sun.jersey.api.client.ClientHandlerException: java.net.ConnectException: 拒绝连接 (Connection refused)
通过这位大大的[blog](https://blog.csdn.net/zzp448561636/article/details/70198878)解决了（可能之后还需要了解一下eureka_(:з」∠)_）
妈的，竟然是这里翻车了，之前拒绝连接应该和这里没问题，是port端口出现了错误，感觉自己有点傻。
7. ConfigServicePropertySourceLocator : Could not locate PropertySource: I/O error on GET request for "http://localhost:8761/config/uaa/dev/master": 拒绝连接 (Connection refused); nested exception is java.net.ConnectException: 拒绝连接 (Connection refused)
通过搜索config中8761找到了还是eureka以及bootstrap可能存在port错误，把8761改成了jhipster-Registry对应的port
8. looks like this：

----------------------------------------------------------
        Application 'uaa' is running! Access URLs:
        Local:          http://localhost:9999/
        External:       http://127.0.0.1:9999/
        Profile(s):     [dev, swagger]
----------------------------------------------------------
2019-05-24 10:43:54.311  INFO 94798 --- [           main] com.mycompany.appstack.UaaApp            :
----------------------------------------------------------
        Config Server:  Not found or not setup for this application
----------------------------------------------------------
是由于*6*和*7*中的错误导致的无法把uaa注册到Registry。
9. 成功注册了为什么jhipster-Registry不显示？？？


#### 资料总结
[别人遇到的关于登录和鉴权的bug](https://blog.csdn.net/qq_38288606/article/details/80137794)

怎么会这样，技术栈难度直线上升的也太快咧。
已经做了的事：1. 了解JHipster上的微服务 2. 看到了最基础的UI创建方法
接下来想要做的事 1. 通过UI转化为jdl进行微服务创建 2. 本次创建采取无中文字符
                1. 在windows上安装jhipster 2. 通过单步调试看看App2到底哪里出问题了
